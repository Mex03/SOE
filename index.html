<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Nota Order</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #0275d8; 
      margin: 0; 
      padding: 20px; 
      display: flex; 
      justify-content: center; 
      align-items: flex-start; 
      min-height: 100vh;
    }
    .card { 
      background: #fff; 
      padding: 20px; 
      border-radius: 12px; 
      width: 100%; 
      max-width: 650px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
    }
    h2 { text-align: center; color: #0275d8; margin-top: 0; }
    h3 { margin-top: 20px; margin-bottom: 8px; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background: #f0f8ff; text-align: center; }

    td.money { padding: 6px; }
    .money-wrap { display: flex; gap: 4px; align-items: center; }
    .money-wrap .rp { min-width: 28px; text-align: left; }
    .money-wrap .nominal { flex: 1; text-align: right; }

    .btn-group { display: flex; gap: 10px; margin-top: 15px; }
    .btn { flex: 1; background: #0275d8; color: #fff; border: none; padding: 10px;
           border-radius: 6px; cursor: pointer; font-size: 15px; }
    .btn:hover { background: #025aa5; }

    .overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4);
               backdrop-filter: blur(3px); z-index: 1000; align-items: center; 
               justify-content: center; padding: 10px; }
    .popup-card { background: #fff; padding: 20px; border-radius: 10px; width: 100%; 
                  max-width: 420px; max-height: 85vh; overflow-y: auto;
                  box-shadow: 0 4px 10px rgba(0,0,0,0.3); position: relative; }
    .popup-card table th, .popup-card table td { text-align: center; }
    .close-btn { position: absolute; top: 10px; right: 12px; cursor: pointer;
                 color: red; font-size: 20px; font-weight: bold; }

    .info-table { width: 100%; border: none; margin-bottom: 10px; }
    .info-table td { border: none; padding: 6px 4px; font-size: 14px; text-align: left; }
    .info-table td.label { font-weight: bold; width: 140px; white-space: nowrap; }

    @media (max-width: 480px) {
      body { padding: 10px; }
      .card { padding: 15px; }
      h2 { font-size: 18px; }
      th, td { font-size: 12px; padding: 6px; }
      .btn { font-size: 14px; padding: 8px; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Nota Order</h2>
    <div id="orderData">Memuat data...</div>

    <h3>Rekap Pesanan</h3>
    <table id="orderTable">
      <thead>
        <tr>
          <th>Artikel</th><th>Qty</th><th>Total</th><th>Diskon</th><th>Total Setelah Diskon</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="5">Memuat data...</td></tr></tbody>
    </table>

    <div class="btn-group">
      <button class="btn" onclick="openInvoice()">üìÑ List Pesanan</button>
      <button class="btn" onclick="openTracking()">üìç Tracking</button>
    </div>
  </div>

  <!-- Invoice Popup -->
  <div class="overlay" id="invoiceOverlay" onclick="closeOverlay(event,'invoiceOverlay')">
    <div class="popup-card">
      <span class="close-btn" onclick="closeInvoice()">‚úñ</span>
      <h3 style="text-align:center; color:#0275d8;">List Pesanan</h3>
      <table id="invoiceTable">
        <thead><tr><th>Nama Artikel</th><th>Qty</th><th>Total Harga</th></tr></thead>
        <tbody><tr><td colspan="3">Memuat data...</td></tr></tbody>
      </table>
    </div>
  </div>

  <script>
    const SPREADSHEET_ID = "1Aff2np0Q5vin7Obj3p51U3D5lJdsxNkAyx0bX3C8yjc";
    const SHEET_ORDER = "IPP";
    const SHEET_INVOICE = "LST_IPP";

    const idOrder = new URLSearchParams(window.location.search).get("id_order");
    let orderData = {}, cachedInvoice = [];

    async function fetchGViz(sheet, query) {
      const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheet}&tq=${encodeURIComponent(query)}`;
      const res = await fetch(url);
      const text = await res.text();
      const jsonText = text.replace(/^[^{]+/,"").replace(/\);?$/,"");
      return JSON.parse(jsonText).table;
    }

    function mapToObjects(table) {
      const headers = table.cols.map(c => (c.label || "").trim());
      console.log("HEADER DARI SHEET:", headers); // debug di console
      return table.rows.map(r => {
        const obj = {};
        headers.forEach((h,i) => obj[h] = r.c[i] ? r.c[i].v : "");
        return obj;
      });
    }

    async function loadData() {
      try {
        const orderTable = await fetchGViz(SHEET_ORDER, `select * where A='${idOrder}'`);
        const invoiceTable = await fetchGViz(SHEET_INVOICE, `select * where E='${idOrder}'`);
        const orders = mapToObjects(orderTable);
        const invoices = mapToObjects(invoiceTable);

        if (!orders.length) throw new Error("Order tidak ditemukan");

        orderData = orders[0];
        cachedInvoice = invoices;
        renderOrder();
      } catch (err) {
        document.getElementById("orderData").innerHTML = `<span style="color:red;">Data tidak ditemukan</span>`;
      }
    }

    function renderOrder() {
      const d = orderData;
      const noWa = d["NO WHATSAPP"] || "-";
      const waLink = noWa !== "-" ? `<a href="https://wa.me/${noWa.replace(/[^0-9]/g,'')}" target="_blank">${noWa}</a>` : "-";

      document.getElementById("orderData").innerHTML = `
        <table class="info-table">
          <tr><td class="label">ID Order</td><td>:</td><td>${d["ID ORDER"]}</td></tr>
          <tr><td class="label">Tanggal Order</td><td>:</td><td>${d["TANGGAL ORDER"]}</td></tr>
          <tr><td class="label">Deadline</td><td>:</td><td>${d["DEADLINE"]}</td></tr>
          <tr><td class="label">Nama Customer</td><td>:</td><td>${d["NAMA CUSTOMER"]}</td></tr>
          <tr><td class="label">No. WhatsApp</td><td>:</td><td>${waLink}</td></tr>
          <tr><td class="label">Alamat</td><td>:</td><td>${d["ALAMAT"]}</td></tr>
        </table>`;

      const totalQty = cachedInvoice.reduce((s,r)=> s+(+r["QTY"]||0),0);
      const totalHarga = +d["TOTAL"]||0;
      const diskon = +d["DISCOUNT"]||0;
      const totalSetelahDiskon = +d["TOTAL SETELAH DISCOUNT"]||0;

      document.querySelector("#orderTable tbody").innerHTML = `
        <tr>
          <td>${d["Artikel Utama / Seaseon"]||"-"}</td>
          <td style="text-align:center">${totalQty}</td>
          <td class="money"><div class="money-wrap"><span class="rp">Rp</span><span class="nominal">${totalHarga.toLocaleString("id-ID")}</span></div></td>
          <td class="money"><div class="money-wrap"><span class="rp">Rp</span><span class="nominal">${diskon.toLocaleString("id-ID")}</span></div></td>
          <td class="money"><div class="money-wrap"><span class="rp">Rp</span><span class="nominal">${totalSetelahDiskon.toLocaleString("id-ID")}</span></div></td>
        </tr>`;
    }

    function openInvoice() {
      const tbody = document.querySelector("#invoiceTable tbody");
      tbody.innerHTML = "";
      if (cachedInvoice.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3">Tidak ada data</td></tr>`;
      } else {
        cachedInvoice.forEach(r=>{
          tbody.insertAdjacentHTML("beforeend",`
            <tr>
              <td>${r["Nama Artikel"]}</td>
              <td>${r["Jml"]}</td>
              <td class="money"><div class="money-wrap"><span class="rp">Rp</span><span class="nominal">${(+r["Total"]||0).toLocaleString("id-ID")}</span></div></td>
            </tr>`);
        });
      }
      document.getElementById("invoiceOverlay").style.display="flex";
    }
    function closeInvoice(){ document.getElementById("invoiceOverlay").style.display="none"; }

    function closeOverlay(e,id){ if(e.target.classList.contains("overlay")) document.getElementById(id).style.display="none"; }

    loadData();
  </script>
</body>
</html>
