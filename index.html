<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Status Order</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --brand: #0077cc;
      --ink: #333;
      --bg: #ff057a;
      --line: #ddd;
      --soft: #e6f2fa;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
      color: var(--ink);
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 { margin-top: 0; color: var(--bg); }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    th, td {
      border: 1px solid var(--line);
      padding: 8px;
      text-align: center;
    }
    th {
      background: var(--soft);
    }
    .money-wrap { display: flex; justify-content: flex-end; }
    .rp { margin-right: 4px; }
    .btn {
      background: var(--brand);
      color: #fff;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn:hover { background: #005fa3; }

    /* Modal tracking */
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
    }
    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
    }
    .close {
      float: right;
      font-size: 24px;
      cursor: pointer;
    }
    .steps {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
    }
    .step {
      width: 22%;
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      background: #eee;
    }
    .step.active { background: var(--brand); color: #fff; }
    .step.done { background: #4caf50; color: #fff; }
    .progress {
      height: 12px;
      background: #eee;
      border-radius: 6px;
      overflow: hidden;
      margin: 15px 0;
    }
    .progress-bar {
      height: 100%;
      width: 0;
      background: var(--brand);
      transition: width 0.6s ease;
    }
    .percent { text-align: right; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Detail Order</h2>
    <p><strong>ID Order:</strong> <span id="id-order">-</span></p>
    <p><strong>Tanggal Order:</strong> <span id="tgl-order">-</span></p>
    <p><strong>Deadline:</strong> <span id="deadline">-</span></p>
    <p><strong>Customer:</strong> <span id="nama-customer">-</span></p>
    <p><strong>No WA:</strong> <span id="no-wa">-</span></p>
    <p><strong>Alamat:</strong> <span id="alamat">-</span></p>

    <h3>Detail Pesanan</h3>
    <table>
      <thead>
        <tr>
          <th>Nama Artikel</th>
          <th>Produk</th>
          <th>Warna</th>
          <th>Qty</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="order-detail">
        <tr><td colspan="5">Memuat data...</td></tr>
      </tbody>
    </table>

    <button class="btn" onclick="openTracking()">Lihat Tracking</button>
  </div>

  <!-- Modal -->
  <div id="trackingModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeTracking()">&times;</span>
      <h3 id="statusText">Status</h3>
      <div class="steps">
        <div id="step-1" class="step">DP</div>
        <div id="step-2" class="step">Produksi</div>
        <div id="step-3" class="step">Selesai</div>
        <div id="step-4" class="step">Siap Ambil/Kirim</div>
      </div>
      <div class="progress">
        <div id="progressBar" class="progress-bar"></div>
      </div>
      <div class="percent"><span id="percentText">0%</span></div>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    function formatDateDDMMMMYYYY(dateStr) {
      if (!dateStr) return "-";
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      const opt = { day: "2-digit", month: "long", year: "numeric" };
      return d.toLocaleDateString("id-ID", opt).replace(/\s/g, " / ");
    }
    function formatNum(n) {
      if (n === undefined || n === null || n === "") return "-";
      const num = typeof n === "string" ? Number(String(n).replace(/[^\d.-]+/g, "")) : n;
      if (isNaN(num)) return n;
      return new Intl.NumberFormat("id-ID").format(num);
    }
    function qs(name, def = "") {
      const p = new URLSearchParams(location.search);
      return p.get(name) ?? def;
    }

    // ===== Config =====
    const idOrder = qs("id_order", "ORD001");
    const apiUrl = "https://script.google.com/macros/s/AKfycbxi5V7MFpzvzAGw1tOdOpF4qwJNS3fvBg5T05KcuftU4w8tKO40H2rtLc7g4vDtGmHg/exec?id_order=" + encodeURIComponent(idOrder);

    let IPP = null;
    let LST_IPP = [];
    let STATUS_RAW = "";

    function statusToStep(status) {
      const s = (status || "").toString().trim().toLowerCase();
      if (["dp", "down payment", "uang muka"].includes(s)) return 1;
      if (["produksi", "proses produksi", "process", "on process"].includes(s)) return 2;
      if (["selesai", "finish", "done", "completed"].includes(s)) return 3;
      if (["siap ambil", "siap kirim", "siap ambil / kirim", "ready to pickup", "ready to ship", "siap ambil/kirim"].includes(s)) return 4;
      return 1;
    }
    function stepToPercent(step) {
      return Math.min(Math.max(step, 1), 4) * 25;
    }

    // ===== Fetch Data dari GAS =====
    fetch(apiUrl)
      .then(r => r.json())
      .then(data => {
        if (!data || !data.IPP) {
          document.querySelector(".container").innerHTML = "<h3>Data tidak ditemukan</h3>";
          return;
        }

        IPP = data.IPP;
        LST_IPP = data.LST_IPP || [];

        // Header
        document.getElementById("id-order").textContent = ORDER["ID ORDER"] || "-";
        document.getElementById("tgl-order").textContent = formatDateDDMMMMYYYY(ORDER["TANGGAL ORDER"]);
        document.getElementById("deadline").textContent = formatDateDDMMMMYYYY(ORDER["DEADLINE"]);
        document.getElementById("nama-customer").textContent = ORDER["NAMA CUSTOMER"] || "-";
        document.getElementById("no-wa").textContent = ORDER["NO WHATSAPP"] || "-";
        document.getElementById("alamat").textContent = ORDER["ALAMAT"] || "-";

        // Detail Pesanan
        const tbody = document.getElementById("order-detail");
        tbody.innerHTML = "";
        if (LST_IPP.length) {
          LST_IPP.forEach(item => {
            tbody.innerHTML += `
              <tr>
                <td>${item["NAMA ARTIKEL"] || "-"}</td>
                <td>${item["PRODUK"] || "-"}</td>
                <td>${item["WARNA"] || "-"}</td>
                <td>${formatNum(item["QTY"])}</td>
                <td class="money">
                  <div class="money-wrap"><span class="rp">Rp</span><span class="nominal">${formatNum(item["TOTAL"])}</span></div>
                </td>
              </tr>`;
          });
        } else {
          tbody.innerHTML = `<tr><td colspan="5">Tidak ada detail pesanan</td></tr>`;
        }

        STATUS_RAW = ORDER["STATUS"] || ORDER["STATUS PRODUKSI"] || "";
      })
      .catch(err => {
        console.error(err);
        document.querySelector(".container").innerHTML = "<h3>Gagal mengambil data</h3>";
      });

    // ===== Tracking Modal =====
    function setStepsActive(step) {
      for (let i = 1; i <= 4; i++) {
        const el = document.getElementById(`step-${i}`);
        if (!el) continue;
        el.classList.remove("active", "done");
        if (i < step) el.classList.add("done");
        if (i === step) el.classList.add("active");
      }
    }
    function animateToPercent(percent) {
      const bar = document.getElementById("progressBar");
      const pctEl = document.getElementById("percentText");
      requestAnimationFrame(() => {
        bar.style.width = percent + "%";
        pctEl.textContent = percent + "%";
      });
    }
    function openTracking() {
      const step = statusToStep(STATUS_RAW || "DP");
      const percent = stepToPercent(step);
      document.getElementById("statusText").textContent = (STATUS_RAW && STATUS_RAW.trim()) ? `Status: ${STATUS_RAW}` : "Status: DP";
      setStepsActive(step);
      animateToPercent(percent);
      document.getElementById("trackingModal").style.display = "block";
    }
    function closeTracking() {
      document.getElementById("trackingModal").style.display = "none";
    }
    window.addEventListener("click", e => {
      if (e.target === document.getElementById("trackingModal")) closeTracking();
    });
  </script>
</body>
</html>
