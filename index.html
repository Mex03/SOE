<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Nota Order & Tracking</title>
<style>
  body { font-family: Arial, sans-serif; background:#0275d8; margin:0; padding:20px; }
  .card { background:#fff; padding:20px; border-radius:8px; margin:auto; width:600px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
  h2 { text-align:center; color:#0275d8; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th,td { border:1px solid #ddd; padding:8px; text-align:center; }
  th { background:#f0f8ff; }
  .btn-container { display:flex; justify-content:center; gap:10px; margin-top:15px; }
  .btn { background:#0275d8; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; transition:0.3s; }
  .btn:hover { background:#025aa5; transform:scale(1.05); }
  .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.3); backdrop-filter:blur(5px); z-index:1000; align-items:center; justify-content:center; }
  .popup-card { background:#fff; padding:15px; border-radius:8px; width:420px; max-height:80vh; overflow-y:auto; box-shadow:0 2px 10px rgba(0,0,0,0.3); position:relative; }
  .close-btn { position:absolute; top:8px; right:10px; cursor:pointer; color:red; font-size:18px; font-weight:bold; }
  .info-table { width:100%; border:none; margin-bottom:15px; }
  .info-table td { border:none; padding:4px 6px; text-align:left; }
  .info-table td.label { font-weight:bold; width:150px; white-space:nowrap; }
  td.money { padding:4px 6px }
  .money-wrap { display:flex; gap:8px; align-items:center; width:100%; }
  .money-wrap .rp { min-width:28px; text-align:left }
  .money-wrap .nominal { flex:1; text-align:right }

  /* Tracking timeline dengan animasi */
  .tracking-container { display:flex; justify-content:space-between; align-items:center; margin:30px auto; max-width:360px; position:relative; }
  .step { text-align:center; flex:1; position:relative; }
  .circle { width:28px; height:28px; border-radius:50%; background:#ccc; margin:auto; transition:all 0.6s ease; box-shadow:0 0 6px rgba(0,0,0,0.2); }
  .label { margin-top:6px; font-size:13px; }
  .line { flex:1; height:4px; background:#ccc; margin:0 4px; transition:background 0.6s ease; }
  .step.active .circle { background:#0275d8; transform:scale(1.2); box-shadow:0 0 10px rgba(2,117,216,0.7); }
  .step.done .circle { background:green; transform:scale(1.1); box-shadow:0 0 8px rgba(0,128,0,0.7); }
  .line.active { background:#0275d8; }
  .line.done { background:green; }
</style>
</head>
<body>
<div class="card">
  <h2>Nota Order</h2>
  <div id="orderData">Memuat data...</div>
  <h3>Rekap Pesanan</h3>
  <table id="orderTable">
    <thead>
      <tr><th>Artikel</th><th>Qty</th><th>Total</th><th>Diskon</th><th>Total Setelah Diskon</th></tr>
    </thead>
    <tbody><tr><td colspan="5">Memuat data...</td></tr></tbody>
  </table>
  <div class="btn-container">
    <button class="btn" onclick="openInvoice()">List Pesanan</button>
    <button class="btn" onclick="openTracking()">Tracking</button>
  </div>
</div>

<!-- Invoice Popup -->
<div class="overlay" id="invoiceOverlay" onclick="closeOverlay(event,'invoiceOverlay')">
  <div class="popup-card">
    <span class="close-btn" onclick="closeInvoice()">✖</span>
    <h3 style="text-align:center;color:#0275d8;">List Pesanan</h3>
    <table id="invoiceTable"><thead><tr><th>Nama Artikel</th><th>Qty</th><th>Total Harga</th></tr></thead><tbody><tr><td colspan="3">Memuat data...</td></tr></tbody></table>
  </div>
</div>

<!-- Tracking Popup -->
<div class="overlay" id="trackingOverlay" onclick="closeOverlay(event,'trackingOverlay')">
  <div class="popup-card">
    <span class="close-btn" onclick="closeTracking()">✖</span>
    <h3 style="text-align:center;color:#0275d8;">Tracking Pesanan</h3>
    <div class="tracking-container">
      <div class="step" id="step-dp"><div class="circle"></div><div class="label">DP</div></div>
      <div class="line" id="line-1"></div>
      <div class="step" id="step-produksi"><div class="circle"></div><div class="label">Produksi</div></div>
      <div class="line" id="line-2"></div>
      <div class="step" id="step-ambil"><div class="circle"></div><div class="label">Sudah Diambil</div></div>
    </div>
  </div>
</div>

<script>
const SPREADSHEET_ID = "1Aff2np0Q5vin7Obj3p51U3D5lJdsxNkAyx0bX3C8yjc"; 
const SHEET_ORDER = "IPP";
const SHEET_INVOICE = "LST_IPP";
const APPSHEET_APP_ID = "f9ea8b38-d0d6-4cb1-b8a3-716e048cc633";
const APPSHEET_KEY = "V2-WKh1n-l3Zod-daH2x-rvv8t-QAPmB-D8BWH-3LafJ-LkxyN";

const idOrder = new URLSearchParams(window.location.search).get("id_order");
let orderData = {};
let cachedInvoice = [];

function formatDate(d){
  if(!d) return "-";
  const dt = new Date(d);
  if(isNaN(dt)) return d;
  return dt.toLocaleDateString('id-ID', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
}

function formatNum(n){
  const num = typeof n === "string" ? Number(n.replace(/[^\d.-]+/g,"")) : n;
  return isNaN(num) ? "-" : new Intl.NumberFormat("id-ID").format(num);
}

async function fetchGVizAsObjects(sheet, query){
  const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheet}&tq=${encodeURIComponent(query)}`;
  const res = await fetch(url);
  const text = await res.text();
  const json = text.replace(/^[^\{]+/,"").replace(/\);?$/,"");
  const data = JSON.parse(json).table;
  const headers = data.cols.map(c => c.label.trim());
  return data.rows.map(row => {
    const obj = {};
    row.c.forEach((cell,i) => { obj[headers[i]] = cell ? (cell.f || cell.v) : ""; });
    return obj;
  });
}

async function loadData(){
  try{
    const orderTbl = await fetchGVizAsObjects(SHEET_ORDER, `select * where A='${idOrder}'`);
    const invoiceTbl = await fetchGVizAsObjects(SHEET_INVOICE, `select * where E='${idOrder}'`);

    if(!orderTbl.length) throw new Error("Data order tidak ditemukan.");
    orderData = orderTbl[0];
    cachedInvoice = invoiceTbl;
    renderOrder();
  }catch(err){
    console.error(err);
    document.getElementById("orderData").innerHTML = "<span style='color:red;'>❌ Terjadi kesalahan saat memuat data.</span>";
    document.querySelector("#orderTable tbody").innerHTML = "<tr><td colspan='5'>Coba muat ulang.</td></tr>";
  }
}

function renderOrder(){
  const d = orderData;
  document.getElementById("orderData").innerHTML = `
    <table class="info-table">
      <tr><td class="label">ID Order</td><td>:</td><td>${d["ID ORDER"] || "-"}</td></tr>
      <tr><td class="label">Tanggal Order</td><td>:</td><td>${formatDate(d["TANGGAL ORDER"])}</td></tr>
      <tr><td class="label">Deadline</td><td>:</td><td>${formatDate(d["DEADLINE"])}</td></tr>
      <tr><td class="label">Nama Customer</td><td>:</td><td>${d["NAMA CUSTOMER"] || "-"}</td></tr>
      <tr><td class="label">Alamat</td><td>:</td><td>${d["ALAMAT"] || "-"}</td></tr>
    </table>`;
  
  document.querySelector("#orderTable tbody").innerHTML = `
    <tr>
      <td>${d["ARTIKEL UTAMA / SEASEON"] || "-"}</td>
      <td>${d["QTY"] || "-"}</td>
      <td class="money"><div class="money-wrap"><span class="rp">Rp</span><span class="nominal">${formatNum(d["TOTAL"])}</span></div></td>
      <td class="money"><div class="money-wrap"><span class="rp">Rp</span><span class="nominal">${formatNum(d["DISCOUNT"])}</span></div></td>
      <td class="money"><div class="money-wrap"><span class="rp">Rp</span><span class="nominal">${formatNum(d["TOTAL SETELAH DISCOUNT"])}</span></div></td>
    </tr>`;
}

function openInvoice(){
  const tb = document.querySelector("#invoiceTable tbody");
  tb.innerHTML = "";
  cachedInvoice.forEach(r => {
    tb.insertAdjacentHTML("beforeend",`<tr><td>${r["NAMA ARTIKEL"]}</td><td>${r["JML"]||"-"}</td><td class="money"><div class="money-wrap"><span class="rp">Rp</span><span class="nominal">${formatNum(r["TOTAL"])}</span></div></td></tr>`);
  });
  document.getElementById("invoiceOverlay").style.display = "flex";
}

function closeInvoice(){ document.getElementById("invoiceOverlay").style.display = "none"; }

async function openTracking(){
  document.getElementById("trackingOverlay").style.display = "flex";
  try {
    const url = `https://api.appsheet.com/api/v2/apps/${APPSHEET_APP_ID}/tables/Tracking/Action`;
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "ApplicationAccessKey": APPSHEET_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        Action: "Find",
        Properties: {},
        Rows: [{ "ID ORDER": idOrder }]
      })
    });
    const data = await res.json();
    updateTrackingUI(data);
  } catch (err) {
    console.error("Error tracking:", err);
  }
}

function updateTrackingUI(data){
  if(!data || !data.length) return;
  const status = data[0]["STATUS"];
  const steps = ["DP","Produksi","Sudah Diambil"];
  let activeIndex = steps.indexOf(status);

  steps.forEach((step, idx) => {
    const stepId = idx === 0 ? "dp" : idx === 1 ? "produksi" : "ambil";
    const stepEl = document.getElementById(`step-${stepId}`);
    if(idx < activeIndex){ stepEl.classList.add("done"); }
    else if(idx === activeIndex){ stepEl.classList.add("active"); }
  });

  if(activeIndex >= 1) document.getElementById("line-1").classList.add("active");
  if(activeIndex >= 2) document.getElementById("line-1").classList.replace("active","done");
  if(activeIndex === 2) document.getElementById("line-2").classList.add("active","done");
}

function closeTracking(){ document.getElementById("trackingOverlay").style.display = "none"; }
function closeOverlay(e,id){ if(e.target.classList.contains("overlay")) document.getElementById(id).style.display = "none"; }

loadData();
</script>
</body>
</html>
