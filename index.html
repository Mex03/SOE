<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Nota & Status Order</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0275d8; margin: 0; padding: 20px; }
    .card { background: #fff; padding: 20px; border-radius: 8px; margin: auto; width: 600px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    h2 { text-align: center; color: #0275d8; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #f0f8ff; }
    .btn { background: #0275d8; color: #fff; border: none; padding: 6px 12px;
           border-radius: 4px; cursor: pointer; margin: 8px 4px 0 0; }
    .btn:hover { background: #025aa5; }
    .overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.3);
               backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center; }
    .popup-card { background: #fff; padding: 15px; border-radius: 8px; width: 420px;
                  max-height: 80vh; overflow-y: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                  position: relative; animation: fadeIn 0.3s ease; }
    .close-btn { position: absolute; top: 8px; right: 10px; cursor: pointer;
                 color: red; font-size: 18px; font-weight: bold; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); }
                        to { opacity: 1; transform: scale(1); } }
    td.money { padding: 4px 6px }
    .money-wrap { display: flex; gap: 8px; align-items: center; width: 100%; }
    .money-wrap .rp { min-width: 28px; text-align: left }
    .money-wrap .nominal { flex: 1; text-align: right }
    .info-table { width: 100%; border: none; margin-bottom: 15px; }
    .info-table td { border: none; padding: 4px 6px; text-align: left; }
    .info-table td.label { font-weight: bold; width: 150px; white-space: nowrap; }

    /* tracking timeline */
    .tracking-container { display: flex; justify-content: space-between; align-items: center;
                          margin: 30px auto; max-width: 360px; }
    .step { text-align: center; flex: 1; position: relative; }
    .circle { width: 28px; height: 28px; border-radius: 50%; background: #ccc;
              margin: auto; transition: all 0.4s ease; box-shadow: 0 0 6px rgba(0,0,0,0.2); }
    .label { margin-top: 6px; font-size: 13px; }
    .line { flex: 1; height: 3px; background: #ccc; margin: 0 4px; transition: background 0.4s ease; }
    .step.done .circle { background: green; transform: scale(1.1); }
    .step.active .circle { background: #0275d8; transform: scale(1.1); }
    .line.done { background: green; }
    .line.active { background: #0275d8; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Nota Order</h2>
    <div id="orderData">Memuat data...</div>

    <h3>Rekap Pesanan</h3>
    <table id="orderTable">
      <thead>
        <tr>
          <th>Artikel</th><th>Qty</th><th>Total</th><th>Diskon</th><th>Total Setelah Diskon</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="5">Memuat data...</td></tr></tbody>
    </table>

    <button class="btn" onclick="openInvoice()">List Pesanan</button>
    <button class="btn" onclick="openTracking()">Tracking</button>
  </div>

  <!-- Invoice Popup -->
  <div class="overlay" id="invoiceOverlay" onclick="closeOverlay(event,'invoiceOverlay')">
    <div class="popup-card">
      <span class="close-btn" onclick="closeInvoice()">✖</span>
      <h3 style="text-align:center; color:#0275d8;">List Pesanan</h3>
      <table id="invoiceTable">
        <thead><tr><th>Nama Artikel</th><th>Qty</th><th>Total Harga</th></tr></thead>
        <tbody><tr><td colspan="3">Memuat data...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Tracking Popup -->
  <div class="overlay" id="trackingOverlay" onclick="closeOverlay(event,'trackingOverlay')">
    <div class="popup-card">
      <span class="close-btn" onclick="closeTracking()">✖</span>
      <h3 style="text-align:center; color:#0275d8;">Tracking Pesanan</h3>
      <div class="tracking-container">
        <div class="step" id="step-dp"><div class="circle"></div><div class="label">DP</div></div>
        <div class="line" id="line-1"></div>
        <div class="step" id="step-produksi"><div class="circle"></div><div class="label">Produksi</div></div>
        <div class="line" id="line-2"></div>
        <div class="step" id="step-ambil"><div class="circle"></div><div class="label">Sudah Diambil</div></div>
      </div>
    </div>
  </div>

  <script>
    // ==== KONFIGURASI ====
    const APP_ID = "f9ea8b38-d0d6-4cb1-b8a3-716e048cc633";
    const ACCESS_KEY = "V2-WKh1n-l3Zod-daH2x-rvv8t-QAPmB-D8BWH-3LafJ-LkxyN";
    const SPREADSHEET_ID = "1Aff2np0Q5vin7Obj3p51U3D5lJdsxNkAyx0bX3C8yjc";
    const SHEET_ORDER = "IPP";
    const SHEET_INVOICE = "LST_IPP";

    const idOrder = new URLSearchParams(window.location.search).get("id_order");

    let orderData = {};
    let cachedInvoice = [];

    // parsing Date(YYYY,MM,DD)
    function parseGVizDate(value) {
      if (!value) return null;
      if (typeof value === "string") {
        const match = value.match(/Date\((\d+),(\d+),(\d+)\)/);
        if (match) {
          return new Date(parseInt(match[1]), parseInt(match[2]), parseInt(match[3]));
        }
        return new Date(value);
      }
      return new Date(value);
    }

    // format DDDD, DD MMMM YYYY
    function formatDateFull(value) {
      const d = parseGVizDate(value);
      if (!d || isNaN(d)) return "-";
      return d.toLocaleDateString("id-ID", {
        weekday: "long", day: "2-digit", month: "long", year: "numeric"
      });
    }

    function formatNum(n) {
      const num = typeof n==="string" ? Number(n.replace(/[^\d.-]+/g,"")) : n;
      return isNaN(num) ? "0" : new Intl.NumberFormat("id-ID").format(num);
    }
    function numOrZero(v) { return isNaN(Number(v)) ? 0 : Number(v); }

    async function fetchGViz(sheet, query) {
      const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheet}&tq=${encodeURIComponent(query)}`;
      const res = await fetch(url);
      const text = await res.text();
      const jsonText = text.replace(/^[^{]+/,"").replace(/\);?$/,"");
      return JSON.parse(jsonText).table;
    }

    function mapToObjects(table) {
      const headers = table.cols.map(c => c.label.trim().toUpperCase());
      return table.rows.map(r => {
        const obj = {};
        headers.forEach((h,i) => obj[h] = r.c[i] ? r.c[i].v : "");
        return obj;
      });
    }

    async function loadData() {
      try {
        const orderTable = await fetchGViz(SHEET_ORDER, `select * where A='${idOrder}'`);
        const invoiceTable = await fetchGViz(SHEET_INVOICE, `select * where E='${idOrder}'`);
        const orders = mapToObjects(orderTable);
        const invoices = mapToObjects(invoiceTable);

        if (!orders.length) throw new Error("Order tidak ditemukan");

        orderData = orders[0];
        cachedInvoice = invoices;

        renderOrder();
      } catch (err) {
        console.error("❌ Error:", err);
        document.getElementById("orderData").innerHTML = `<span style="color:red;">Data tidak ditemukan</span>`;
      }
    }

    function renderOrder() {
      const d = orderData;

      const infoHTML = `
        <table class="info-table">
          <tr><td class="label">ID Order</td><td>:</td><td>${d["ID ORDER"]}</td></tr>
          <tr><td class="label">Tanggal Order</td><td>:</td><td>${formatDateFull(d["TANGGAL ORDER"])}</td></tr>
          <tr><td class="label">Deadline</td><td>:</td><td>${formatDateFull(d["DEADLINE"])}</td></tr>
          <tr><td class="label">Nama Customer</td><td>:</td><td>${d["NAMA CUSTOMER"]}</td></tr>
          <tr><td class="label">No. WhatsApp</td><td>:</td><td>${d["NO WHATSAPP"]}</td></tr>
          <tr><td class="label">Alamat</td><td>:</td><td>${d["ALAMAT"]}</td></tr>
        </table>`;
      document.getElementById("orderData").innerHTML = infoHTML;

      const totalQty = cachedInvoice.reduce((sum,r)=> sum+numOrZero(r["JML"]),0);
      const totalHarga = numOrZero(d["TOTAL"]);
      const diskon = numOrZero(d["DISCOUNT"]);
      const totalSetelahDiskon = numOrZero(d["TOTAL SETELAH DISCOUNT"]);

      document.querySelector("#orderTable tbody").innerHTML = `
        <tr>
          <td>${d["ARTIKEL UTAMA / SEASEON"]}</td>
          <td>${formatNum(totalQty)}</td>
          <td class="money"><div class="money-wrap"><span class="rp">Rp</span><span class="nominal">${formatNum(totalHarga)}</span></div></td>
          <td class="money"><div class="money-wrap"><span class="rp">Rp</span><span class="nominal">${formatNum(diskon)}</span></div></td>
          <td class="money"><div class="money-wrap"><span class="rp">Rp</span><span class="nominal">${formatNum(totalSetelahDiskon)}</span></div></td>
        </tr>`;
    }

    function openInvoice() {
      const tbody = document.querySelector("#invoiceTable tbody");
      tbody.innerHTML = "";
      if (cachedInvoice.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3">Tidak ada data</td></tr>`;
      } else {
        cachedInvoice.forEach(r=>{
          tbody.insertAdjacentHTML("beforeend",`
            <tr>
              <td>${r["NAMA ARTIKEL"]}</td>
              <td>${r["JML"]}</td>
              <td class="money"><div class="money-wrap"><span class="rp">Rp</span><span class="nominal">${formatNum(r["TOTAL"])}</span></div></td>
            </tr>`);
        });
      }
      document.getElementById("invoiceOverlay").style.display="flex";
    }
    function closeInvoice(){ document.getElementById("invoiceOverlay").style.display="none"; }

    // tracking dari AppSheet API
    async function fetchTracking() {
      const url = `https://api.appsheet.com/api/v2/apps/${APP_ID}/tables/IPP/Action`;
      const payload = { Action:"Find", Properties:{}, Rows:[{"ID ORDER":idOrder}] };
      const res = await fetch(url,{
        method:"POST",
        headers:{"ApplicationAccessKey":ACCESS_KEY,"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
      const data = await res.json();
      return data.length? data[0]: null;
    }

    function resetTrackingSteps() {
      ["step-dp","step-produksi","step-ambil"].forEach(id=>{
        document.getElementById(id).classList.remove("done","active");
      });
      ["line-1","line-2"].forEach(id=>{
        document.getElementById(id).classList.remove("done","active");
      });
    }

    function openTracking() {
      resetTrackingSteps();
      fetchTracking().then(track=>{
        if (!track) return;
        if (Number(track["TOTAL DP"]||0)>0) document.getElementById("step-dp").classList.add("done");
        if (track["STATUS PRODUKSI"]==="SELESAI") {
          document.getElementById("step-produksi").classList.add("done");
          document.getElementById("line-1").classList.add("done");
        }
        if (track["TANGGAL PENGAMBILAN"]) {
          document.getElementById("step-ambil").classList.add("done");
          document.getElementById("line-2").classList.add("done");
        }
        document.getElementById("trackingOverlay").style.display="flex";
      });
    }
    function closeTracking(){ document.getElementById("trackingOverlay").style.display="none"; }

    function closeOverlay(e,id){ if(e.target.classList.contains("overlay")) document.getElementById(id).style.display="none"; }

    loadData();
  </script>
</body>
</html>
